name: RBE Master Sync

on:
  schedule:
    # Daily at 07:15 UTC; adjust as needed
    - cron: '15 7 * * *'
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Branch to track and push to rbe (default: master)'
        required: false
      upstream_repo:
        description: 'Upstream repo owner/name (default: bazelbuild/bazel)'
        required: false
      target_repo:
        description: 'Target repo owner/name (default: sluongng/bazel-rbe)'
        required: false

env:
  BASE_BRANCH: ${{ github.event.inputs.base_branch || 'master' }}
  UPSTREAM_REPO: ${{ github.event.inputs.upstream_repo || 'bazelbuild/bazel' }}
  TARGET_REPO: ${{ github.event.inputs.target_repo || 'sluongng/bazel-rbe' }}

jobs:
  sync:
    runs-on: ubuntu-slim
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Don't persist the default GITHUB_TOKEN credentials; we use PAT instead
          persist-credentials: false

      - name: Ensure push token is available
        env:
          TOKEN: ${{ secrets.RBE_PUSH_TOKEN }}
        run: |
          if [ -z "${TOKEN}" ]; then
            echo "::error::Set the RBE_PUSH_TOKEN secret with a PAT that can push to ${TARGET_REPO}" >&2
            exit 2
          fi

      - name: Configure git remotes
        env:
          PUSH_TOKEN: ${{ secrets.RBE_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          # Ensure no leftover GITHUB_TOKEN extraheader overrides our PAT
          git config --unset-all http.https://github.com/.extraheader || true
          git config user.name "rbe-sync-bot"
          git config user.email "actions@github.com"
          # origin is already sluongng/bazel-rbe (where workflow runs), rename to rbe
          git remote rename origin rbe
          # Configure rbe remote with PAT for push access
          git remote set-url rbe https://${PUSH_TOKEN}@github.com/${TARGET_REPO}.git
          # Add upstream remote (bazelbuild/bazel)
          git remote add upstream https://github.com/${UPSTREAM_REPO}.git
          git remote -v

      - name: Fetch branches
        run: |
          set -euo pipefail
          git fetch upstream ${BASE_BRANCH} --tags
          git fetch rbe ${BASE_BRANCH} || true
      - name: Rebase onto each new upstream commit and push
        run: |
          set -euo pipefail

          # Start from the rbe branch (your stack of commits)
          git checkout -B ${BASE_BRANCH} rbe/${BASE_BRANCH}

          # Identify the upstream commit our current stack is based on.
          old_base=$(git merge-base upstream/${BASE_BRANCH} HEAD)
          if [ -z "${old_base}" ]; then
            echo "::error::Unable to determine base between upstream/${BASE_BRANCH} and rbe/${BASE_BRANCH}" >&2
            exit 3
          fi

          # Walk new upstream commits in first-parent order (chronological).
          new_commits=$(git rev-list --first-parent --reverse ${old_base}..upstream/${BASE_BRANCH})
          if [ -z "${new_commits}" ]; then
            echo "No new upstream commits; pushing current state for completeness."
            git push --force-with-lease rbe HEAD:${BASE_BRANCH}
            exit 0
          fi

          echo "Found $(echo "${new_commits}" | wc -l | xargs) new upstream commits to replay."

          for new_base in ${new_commits}; do
            echo "::group::Rebasing stack onto ${new_base}"
            git rebase --rebase-merges --onto ${new_base} ${old_base} ${BASE_BRANCH}
            git push --force-with-lease rbe HEAD:${BASE_BRANCH}
            old_base=${new_base}
            sleep 5
            echo "::endgroup::"
          done
